# vm2 替换计划（douyu-recorder 加密算法重构）

> 状态：待执行
> 优先级：P0 安全
> 创建日期：2026-02-15

## 背景

vm2 于 2023 年 7 月正式废弃，存在多个 Critical 级别沙箱逃逸漏洞（CVE-2023-37466、CVE-2023-37903、CVE-2026-22709 CVSS 9.8）。

douyu-recorder 使用 vm2 执行斗鱼平台的加密/签名脚本，用于生成直播流请求中的签名参数。这涉及到斗鱼平台的反爬虫机制，替换 vm2 的同时需要重新评估和实现加密算法的执行方案。

## 待办事项

### 1. 审计现有 vm2 用法

- [ ] 分析 `packages/douyu-recorder/src` 中所有 `vm2` 的 import 和使用场景
- [ ] 梳理斗鱼签名算法的输入/输出接口
- [ ] 确认执行的 JS 脚本来源（是静态内置还是从斗鱼 API 动态获取）

### 2. 选择替代方案

| 方案 | 优点 | 缺点 |
|------|------|------|
| **isolated-vm** | V8 isolate 真正隔离，安全性高 | 原生模块，Electron 打包需额外配置 |
| **Node.js vm 模块（受限上下文）** | 无额外依赖 | 安全性不如 isolated-vm，但如果执行的是可控脚本则可接受 |
| **直接提取纯函数** | 最简单，零依赖 | 需要完全理解加密算法，斗鱼更新后需同步 |
| **quickjs-emscripten** | WASM 沙箱，跨平台 | 性能可能略低 |

### 3. 实施替换

- [ ] 根据审计结果选定方案
- [ ] 实现替换代码
- [ ] 测试斗鱼直播流获取功能

## 关联

- 主升级计划：`docs/dependency-upgrade-plan.md`
- 斗鱼录制器：`packages/douyu-recorder/`
